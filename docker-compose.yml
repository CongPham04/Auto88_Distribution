version: '3.8'

services:
  # ------------------------------------
  # 1. Database Service (MySQL)
  # ------------------------------------
  db:
    image: mysql:8.0
    container_name: auto88_mysql
    environment:
      MYSQL_DATABASE: car_sales_db 
      MYSQL_ROOT_PASSWORD: Auto88SecurePwd
    ports:
      - "3306:3306"
    volumes:
      - db_data:/var/lib/mysql
    hostname: db
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
      interval: 5s
    restart: always

  # ------------------------------------
  # 2. Backend Service
  # ------------------------------------
  backend:
    # ‚ùå ƒê√É X√ìA PH·∫¶N BUILD
    # ‚úÖ Thay b·∫±ng Image tr√™n Docker Hub c·ªßa b·∫°n
    image: dieuduong_it/auto88-backend:v1  
    container_name: auto88_be
    ports:
      - "8080:8080"
    environment:
      MAIL_USERNAME: auto88.com.vn@gmail.com
      MAIL_PASSWORD: ufdmjnkbkgcjpmjq 
      # üëá C·∫ßn nh·∫Øc ng∆∞·ªùi nh·∫≠n thay ƒë·ªïi n·∫øu h·ªç ch·∫°y tr√™n domain/IP kh√°c
      FRONTEND_URL: http://localhost:80 
      APP_BASE_URL: http://localhost:80/carshop
      
      SPRING_DATASOURCE_URL: jdbc:mysql://db:3306/car_sales_db?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Auto88SecurePwd
      
      JWT_SECRET: HCUzp+KbjzGwPpBYKLChUvu9WUc+D9b3kAvq1cDi45jkVKzf+EF9bpIeq42e0KFSm7Lqm2i93YLmi4qQ9lW5g== 
      CORS_ALLOWED_ORIGINS: "*" # Cho ph√©p t·∫•t c·∫£ ƒë·ªÉ ng∆∞·ªùi kh√°c d·ªÖ test
      SERVER_SERVLET_CONTEXT_PATH: /carshop

    volumes:
      # üëá ƒê√£ s·ª≠a: D√πng volume ·∫£o thay v√¨ tr·ªè v√†o th∆∞ m·ª•c code c≈©
      - uploads_data:/app/uploads
    depends_on:
      db:
        condition: service_healthy
    restart: always

  # ------------------------------------
  # 3. Frontend Service
  # ------------------------------------
  frontend:
    # ‚ùå ƒê√É X√ìA PH·∫¶N BUILD
    # ‚úÖ Thay b·∫±ng Image tr√™n Docker Hub c·ªßa b·∫°n
    image: dieuduong_it/auto88-frontend:v1
    container_name: auto88_fe
    ports:
      - "80:80"
    depends_on:
      - backend
    restart: always

# ƒê·ªãnh nghƒ©a c√°c ·ªï ƒëƒ©a ·∫£o ƒë·ªÉ l∆∞u d·ªØ li·ªáu l√¢u d√†i
volumes:
  db_data:      # L∆∞u d·ªØ li·ªáu MySQL
  uploads_data: # L∆∞u ·∫£nh upload (ƒë√£ s·ª≠a cho g·ªçn)